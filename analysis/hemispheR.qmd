---
title: "Canopy fraction"
format: html
editor: visual
---

```{r}
#| label: packages
# install.packages("hemispheR")
library(tidyverse)
library(hemispheR)
library(cowplot)
theme_set(theme_cowplot())
```

```{r}
index <- read.csv("data/canopy pictures/canopyPhoto_index.csv",
                  stringsAsFactors = FALSE)

index$PhotoID = as.numeric(index$PhotoID)

summary(index)  
```

```{r}

ph10_0 <- import_fisheye(filename = paste0("data/canopy pictures/DSC0", index$PhotoID[18], ".JPG"),
                       circular = TRUE, display = TRUE)
plot(ph10_0)

ph10_0_bin <- binarize_fisheye(ph10_0, display = TRUE)
plot(ph10_0_bin)


ph10_0_data <- as.data.frame(ph10_0_bin) # 0 is canopy # 1 is sky

length(which(ph10_0_data == 1)) / length(which(ph10_0_data == 0))

```

```{r}
# Define the path to your folder containing JPG files
folder_path <- "data/canopy pictures/"

# List all JPG files in the folder
file_list <- list.files(path = folder_path, pattern = "\\.JPG$", full.names = TRUE)

# Initialize an empty data frame to store results
results <- data.frame(
  PhotoID = character(),
  ratio = integer(),
  percentSky = integer(),
  stringsAsFactors = FALSE
)

for (file_path in file_list) {
  
  photo <- hemispheR::import_fisheye(filename = file_path,
                       circular = TRUE, message = FALSE)
  
  photo_bin <- binarize_fisheye(photo, zonal = TRUE)
  
  photoData <- as.data.frame(photo_bin)
  
  ratio <- length(which(photoData == 1)) / length(which(photoData == 0))
  
  percentSky <- length(which(photoData == 1)) / nrow(photoData)
  
  # Append the results to the data frame
  results <- rbind(results, data.frame(
    PhotoID = file_path,
    ratio = ratio,
    percentSky = percentSky,
    stringsAsFactors = FALSE
  ))
  
}

results <- results %>%
    mutate(PhotoID = str_extract(PhotoID, "\\d{4}(?=\\.JPG)"))

results$PhotoID <- as.numeric(results$PhotoID)

rm(file_list, file_path, folder_path,percentSky, ratio, 
   photo_bin, photo, photoData)

results <- full_join(results, index,
by = join_by(PhotoID))

results <- results %>%
  filter(Site != "Outtake")

```

```{r}
write.csv(results, "data/canopyOpen.csv", row.names = FALSE)
```

```{r}
ggplot(results, aes(x = as.factor(treat), y = percentSky, fill = site)) + geom_boxplot()

```


```{r}

ph7_3 <- import_fisheye(filename = "data/canopy pictures/7_3.JPG",
                       circular = TRUE, display = TRUE)
plot(ph7_3)


ph7_3_bin <- binarize_fisheye(ph7_3, display = TRUE)
plot(ph7_3_bin)

ph7_3_bin <- binarize_fisheye(ph7_3, zonal = TRUE, display = TRUE)

ph7_3_bin <- binarize_fisheye(ph7_3, manual = 45, display = TRUE)


ph7_3_data <- as.data.frame(ph7_3_bin) # 0 is canopy # 1 is sky

length(which(ph7_3_data == 1)) / nrow(ph7_3_data)

```
